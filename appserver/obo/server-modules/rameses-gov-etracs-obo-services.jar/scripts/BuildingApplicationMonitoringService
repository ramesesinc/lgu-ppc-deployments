import com.rameses.annotations.*;

class BuildingApplicationMonitoringService {

	@DataContext("vw_building_permit")
	def bldgPermitEm;

	
	@ActiveDB("building_permit_task_monitor")
	def taskMonitor;

    @ProxyMethod
    public def getInfo( def o  ) {
    	def app = bldgPermitEm.find( [objid: o.appid ] ).first();

    	def res = [:];
    	res.appno = app.appno;
    	res.trackingno = app.trackingno;
    	res.title = app.title;
    	res.applicant = app.applicant;
    	res.location = app.location;
    	res.txntype = app.txntype;
    	res.doctype = "BUILDING PERMIT";    	

    	def list = taskMonitor.getMainTasks( [appid: o.appid ] );
    	if(list) {
    		def t = [appid: o.appid];    	
    		list.each {
    			t.putAll( it );
    			def subtasks = taskMonitor.getSubTasks( t );
    			if(subtasks) {
    				def sublist = [];    			
    				def grpList = subtasks.groupBy{ it.section };
    				grpList.each { k,v->
    					def z = [:];
    					z.section = k;
    					z.org = v.first().org;
    					z.startdate = v.first().startdate;
    					z.enddate = null;
    					if( v.first()!=v.last()) {
    						z.enddate = v.last().startdate;    					
    					}
    					z.state = v.last().state;    					
    					sublist << z;    					
    				}
    				it.subtasks  = sublist;
    			}
    		}
    	}
    	res.tasks = list;

    	/*
    	println "**************************************"
    	list.each {
    		if(it.subtasks) {
    			it.subtasks.each {
    				println "    " + [section:it.section, state:it.state, startdate: it.startdate, enddate: it.enddate ];
    			}
    		}
    	}
    	*/
    	return res;
    }

	
}